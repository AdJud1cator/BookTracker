<!DOCTYPE html>
<html lang="en" data-bs-theme="light">

<head>
  <meta charset="UTF-8" />
  <title>Book Details - BookTracker</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.5/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">

  <link rel="stylesheet" href="../static/css/styles.css" />
  <style>
    .book-details-container {
      max-width: 700px;
      margin: 3rem auto;
      background: #fff;
      border-radius: 0.5rem;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.07);
      padding: 2rem;
    }

    .book-cover {
      width: 150px;
      height: 220px;
      object-fit: cover;
      border-radius: 0.25rem;
      margin-right: 2rem;
    }

    .book-meta {
      flex: 1;
    }

    .status-btn-group .btn {
      min-width: 140px;
    }

    @media (max-width: 600px) {
      .book-details-flex {
        flex-direction: column;
        align-items: center;
      }

      .book-cover {
        margin-right: 0;
        margin-bottom: 1rem;
      }

      .book-meta {
        width: 100%;
      }
    }
  </style>
</head>

<body class="bg-body">
  <!-- Navbar (reuse your dashboard navbar here) -->

  <nav class="navbar navbar-expand-lg navbar-dark bg-primary shadow-sm">
    <div class="container">
      <a class="navbar-brand fw-bold" href="{{ url_for('dashboard') }}">BookTracker</a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav"
        aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse justify-content-end" id="navbarNav">
        <div class="navbar-nav">
          <a class="nav-link" href="{{ url_for('dashboard') }}">Dashboard</a>
          <a class="nav-link" href="{{ url_for('explore') }}">Explore</a>
          <a class="nav-link" href="{{ url_for('library') }}">Library</a>
          <a class="nav-link" href="{{ url_for('community') }}">Community</a>
          <a class="nav-link" href="{{ url_for('statistics') }}">Statistics</a>
          <a class="nav-link" href="{{ url_for('logout') }}">Sign Out</a>
        </div>
      </div>
    </div>
  </nav>

  <div class="book-details-container shadow-sm bg-body position-relative">
    <!-- Close Button in top left -->
    <a href="{{ request.referrer or url_for('homepage') }}" 
       class="btn-close position-absolute" 
       style="top: 1rem; right: 1rem;" 
       aria-label="Close" title="Back"></a>
  
    <!-- Main content starts below the X button -->
    <div class="d-flex book-details-flex mt-5 pt-2">
  
      <img id="bookCover" class="book-cover" src="" alt="Book cover">
      <div class="book-meta">
        <h2 id="bookTitle" class="fw-semibold text-primary"></h2>
        <div class="mb-2"><strong>Authors:</strong> <span id="bookAuthors"></span></div>
        <div class="mb-2"><strong>Publisher:</strong> <span id="bookPublisher"></span></div>
        <div class="mb-2"><strong>Published:</strong> <span id="bookPublished"></span></div>
        <div class="mb-2"><strong>Page Count:</strong> <span id="bookPages"></span></div>
        <div class="mb-2"><strong>Categories:</strong> <span id="bookCategories"></span></div>

        <div class="mb-2">
          <strong>Rating:</strong>
          <span id="bookRating"></span>
          <small id="ratingsCount" class="text-muted"></small>
        </div>
        
        <div class="mb-2"><strong>ISBN:</strong> <span id="bookISBN"></span></div>
      </div>
    </div>
    <hr>
    <div class="mb-4">
      <h5>Add to your Library</h5>
      <div class="status-btn-group btn-group" role="group" aria-label="Reading status">
        <button type="button" class="btn btn-outline-primary" onclick="setStatus('currently_reading')">Currently
          Reading</button>
        <button type="button" class="btn btn-outline-success" onclick="setStatus('completed')">Completed</button>
        <button type="button" class="btn btn-outline-secondary" onclick="setStatus('wishlist')">Wishlist</button>
      </div>
      <div id="statusMessage" class="mt-3"></div>
    </div>
    <div class="mb-3">
      <h5>Description</h5>
      <div id="bookDescription" style="white-space: pre-line;"></div>
    </div>
    
    <a id="previewLink" href="#" target="_blank" class="btn btn-link">Preview on Google Books</a>
  </div>

  <!-- Footer (same as other pages) -->
  <footer class="text-center text-muted mt-5 mb-3 small">
    <div class="mb-2">
      <a href="https://www.facebook.com/" class="text-decoration-none text-primary mx-2">Facebook</a> ·
      <a href="https://www.x.com/" class="text-decoration-none text-primary mx-2">Twitter</a> ·
      <a href="https://www.instagram.com/" class="text-decoration-none text-primary mx-2">Instagram</a>
    </div>
    <div class="mb-2">
      <a href="#" id="darkModeToggleLink" class="text-decoration-none text-primary mx-2"><span id="darkModeStatus">Dark
          Mode</span></a> ·
      <a href="{{ url_for('contact') }}" class="text-decoration-none text-primary mx-2">Contact</a>
    </div>
    <div>
      <a href="{{ url_for('terms') }}" class="text-decoration-none text-primary mx-2">Terms & Conditions</a> ·
      <a href="{{ url_for('policy') }}" class="text-decoration-none text-primary mx-2">Privacy Policy</a> ·
      <a href="{{ url_for('copyright') }}" class="text-decoration-none text-primary mx-2">Copyright</a>
    </div>
  </footer>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <script src="{{ url_for('static', filename='js/dark.js') }}"></script>
  <script>
    const googleid = "{{ googleid }}";
    let bookTitle = "", bookAuthors = "", bookCover = "", bookDesc = "", bookGenre = "", pageCount = null;

    async function fetchBookDetails() {
      const url = `https://www.googleapis.com/books/v1/volumes/${googleid}`;
      const resp = await fetch(url);
      const data = await resp.json();
      return data;
    }
    function displayBookDetails(book) {
      const info = book.volumeInfo || {};
      bookTitle = info.title || 'No Title';
      bookAuthors = (info.authors && info.authors.join(', ')) || 'Unknown Author';
      bookCover = (info.imageLinks && info.imageLinks.thumbnail) || 'https://via.placeholder.com/150x220?text=No+Cover';
      bookDesc = info.description || '';
      bookGenre = (info.categories && info.categories.length > 0) ? info.categories[0].split('/')[0].trim(): 'Uncategorised';
      pageCount = info.pageCount || null;

      document.getElementById('bookCover').src = bookCover;
      document.getElementById('bookTitle').textContent = bookTitle;
      document.getElementById('bookAuthors').textContent = bookAuthors;
      document.getElementById('bookPublisher').textContent = info.publisher || 'Unknown Publisher';
      document.getElementById('bookPublished').textContent = info.publishedDate || 'Unknown Date';
      document.getElementById('bookPages').textContent = info.pageCount || 'Unknown';
      document.getElementById('bookCategories').textContent = bookGenre;

      // Star Rating
      const rating = info.averageRating || 0;
      const ratingsCount = info.ratingsCount || 0;

      let starsHtml = '';
      for (let i = 1; i <= 5; i++) {
        if (i <= Math.floor(rating)) {
          starsHtml += '<i class="bi bi-star-fill text-warning"></i>';
        } else if (i - rating < 1) {
          starsHtml += '<i class="bi bi-star-half text-warning"></i>';
        } else {
          starsHtml += '<i class="bi bi-star text-warning"></i>';
        }
      }
      document.getElementById('bookRating').innerHTML = starsHtml;
      document.getElementById('ratingsCount').textContent = ratingsCount ? `(${ratingsCount} ratings)` : '';


      let isbn = '-';
      if (info.industryIdentifiers && info.industryIdentifiers.length) {
        isbn = info.industryIdentifiers.map(i => i.identifier).join(', ');
      }
      document.getElementById('bookISBN').textContent = isbn;
      document.getElementById('bookDescription').innerHTML = bookDesc || 'No description available.';
      document.getElementById('previewLink').href = (info.previewLink || '#');
    }
    function setStatus(status) {
      fetch("/add_book", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          google_id: googleid,
          title: bookTitle,
          author: bookAuthors,
          description: bookDesc,
          cover_url: bookCover,
          genre: bookGenre,
          page_count: pageCount,
          status: status
        })
      })
        .then(response => response.json())
        .then(data => {
          Swal.fire({
            icon: data.success ? 'success' : 'error',
            title: data.message
          });
        });
    }
    fetchBookDetails().then(displayBookDetails);
</script>

</body>

</html>