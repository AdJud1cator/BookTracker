{% extends "base_member.html" %}

{% block title %}Statistics - BookTracker{% endblock %}

{% block head %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
    .stats-container {
        max-width: 1100px;
        margin: 2rem auto;
    }

    .stats-grid {
        display: flex;
        flex-wrap: wrap;
        gap: 1.5rem;
        margin-bottom: 2.5rem;
    }

    .stat-card {
        flex: 1 1 180px;
        min-width: 180px;
        background: var(--bs-body-bg, #fff);
        border-radius: 0.7rem;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.07);
        padding: 1.3rem 1.2rem 1.1rem 1.2rem;
        display: flex;
        flex-direction: column;
        align-items: flex-start;
        justify-content: center;
    }

    .stat-label {
        font-size: 1.02rem;
        color: var(--bs-secondary-color, #6c757d);
        margin-bottom: 0.3rem;
    }

    .stat-value {
        font-size: 2.1rem;
        font-weight: 700;
        color: var(--bs-primary, #0d6efd);
        margin-bottom: 0.2rem;
    }

    .stat-extra {
        font-size: 1.02rem;
        color: var(--bs-secondary-color, #6c757d);
    }

    .chart-card {
        background: var(--bs-body-bg, #fff);
        border-radius: 1rem;
        box-shadow: 0 2px 12px rgba(0, 0, 0, 0.07);
        padding: 2rem;
        margin-bottom: 2rem;
    }

    .chart-title {
        font-weight: 600;
        color: var(--bs-primary, #0d6efd);
        margin-bottom: 1rem;
    }

    .stat-break {
        flex-basis: 100%;
        height: 0;
    }

    @media (max-width: 900px) {
        .stats-grid {
            flex-direction: column;
            gap: 1rem;
        }

        .chart-card {
            padding: 1rem;
        }
    }

    [data-bs-theme="dark"] .chart-card,
    [data-bs-theme="dark"] .stat-card {
        background: #232137;
        color: #f8f9fa;
    }
</style>
{% endblock %}

{% block content %}
<div class="stats-container px-4">
    <!-- Stat Cards -->
    <div class="stats-grid" id="statCards">
        <!-- Populated by JS -->
    </div>
    <!-- Charts -->
    <div class="chart-card">
        <div class="chart-title">Books by Genre (Top 10)</div>
        <canvas id="genrePie"></canvas>
    </div>
    <div class="chart-card">
        <div class="chart-title">Books by Status</div>
        <canvas id="statusPie" width="100" height="1000"></canvas>
    </div>
    <div class="chart-card">
        <div class="chart-title">Top Authors</div>
        <canvas id="authorBar"></canvas>
    </div>
    <div class="chart-card">
        <div class="chart-title">Books Read Over Time</div>
        <div class="mb-3">
            <select id="booksTimeRange" class="form-select" style="max-width:200px;">
                <option value="weeks">By Week</option>
                <option value="months" selected>By Month</option>
                <option value="years">By Year</option>
                <option value="all">All Time</option>
            </select>
        </div>
        <canvas id="booksOverTime"></canvas>
    </div>
    <div class="chart-card">
        <div class="chart-title">Pages Read Over Time</div>
        <div class="mb-3">
            <select id="pagesTimeRange" class="form-select" style="max-width:200px;">
                <option value="weeks">By Week</option>
                <option value="months" selected>By Month</option>
                <option value="years">By Year</option>
                <option value="all">All Time</option>
            </select>
        </div>
        <canvas id="pagesOverTime"></canvas>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        // --- Stat Cards ---
        fetch('/stats/summary')
            .then(res => res.json())
            .then(stats => {
                document.getElementById('statCards').innerHTML = `
            <div class="stat-card">
                <div class="stat-label">Total Books Read</div>
                <div class="stat-value">${stats.total_books_read}</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Total Pages Read</div>
                <div class="stat-value">${stats.total_pages_read}</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Favorite Genre</div>
                <div class="stat-value">${stats.favorite_genre || '-'}</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Most-Read Author</div>
                <div class="stat-value">${stats.most_read_author || '-'}</div>
            </div>
            <div class="stat-break"></div>
            <div class="stat-card">
                <div class="stat-label">Longest Book Read</div>
                <div class="stat-value" style="font-size:1.15rem;">${stats.longest_book?.title || '-'}</div>
                <div class="stat-extra">${stats.longest_book?.pages ? stats.longest_book.pages + ' pages' : ''}</div>
            </div>
            <div class="stat-break"></div>
            <div class="stat-card">
                <div class="stat-label">Shortest Book Read</div>
                <div class="stat-value" style="font-size:1.15rem;">${stats.shortest_book?.title || '-'}</div>
                <div class="stat-extra">${stats.shortest_book?.pages ? stats.shortest_book.pages + ' pages' : ''}</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Books Shared</div>
                <div class="stat-value">${stats.books_shared}</div>
            </div>
        `;
            });

        // --- Books Over Time Chart ---
        let booksOverTimeChart;
        function renderBooksOverTime(range) {
            fetch(`/stats/books_over_time?range=${range}`)
                .then(res => res.json())
                .then(booksOverTimeData => {
                    const ctx = document.getElementById('booksOverTime');
                    if (booksOverTimeChart) booksOverTimeChart.destroy();
                    booksOverTimeChart = new Chart(ctx, {
                        type: range === 'years' || range === 'all' ? 'bar' : 'line',
                        data: {
                            labels: booksOverTimeData.labels,
                            datasets: [{
                                label: "Books Completed",
                                data: booksOverTimeData.data,
                                backgroundColor: "#0d6efd",
                                borderColor: "#0d6efd",
                                tension: 0.25,
                                fill: true
                            }]
                        },
                        options: {
                            scales: {
                                y: { beginAtZero: true, ticks: { stepSize: 1 } }
                            }
                        }
                    });
                });
        }
        renderBooksOverTime('months');
        document.getElementById('booksTimeRange').addEventListener('change', function () {
            renderBooksOverTime(this.value);
        });

        // --- Pages Over Time Chart ---
        let pagesOverTimeChart;
        function renderPagesOverTime(range) {
            fetch(`/stats/pages_over_time?range=${range}`)
                .then(res => res.json())
                .then(pagesOverTimeData => {
                    const ctx = document.getElementById('pagesOverTime');
                    if (pagesOverTimeChart) pagesOverTimeChart.destroy();
                    pagesOverTimeChart = new Chart(ctx, {
                        type: range === 'years' || range === 'all' ? 'bar' : 'line',
                        data: {
                            labels: pagesOverTimeData.labels,
                            datasets: [{
                                label: "Pages Read",
                                data: pagesOverTimeData.data,
                                backgroundColor: "#20c997",
                                borderColor: "#20c997",
                                tension: 0.25,
                                fill: true
                            }]
                        },
                        options: {
                            scales: {
                                y: { beginAtZero: true }
                            }
                        }
                    });
                });
        }
        renderPagesOverTime('months');
        document.getElementById('pagesTimeRange').addEventListener('change', function () {
            renderPagesOverTime(this.value);
        });

        // --- Genre Pie Chart ---
        fetch('/stats/genres')
            .then(res => res.json())
            .then(genreData => {
                const genreLabels = Object.keys(genreData);
                const genreCounts = Object.values(genreData);
                new Chart(document.getElementById('genrePie'), {
                    type: 'doughnut',
                    data: {
                        labels: genreLabels,
                        datasets: [{
                            data: genreCounts,
                            backgroundColor: [
                                "#0d6efd", "#6610f2", "#6f42c1", "#d63384", "#fd7e14", "#ffc107", "#198754", "#20c997", "#0dcaf0", "#adb5bd", "#6c757d"
                            ]
                        }]
                    },
                    options: {
                        plugins: {
                            legend: { position: 'right' },
                            tooltip: {
                                callbacks: {
                                    label: function (context) {
                                        const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                        const count = context.parsed;
                                        const percent = ((count / total) * 100).toFixed(1);
                                        return `${context.label}: ${count} (${percent}%)`;
                                    }
                                }
                            }
                        }
                    }
                });
            });

        // --- Status Pie Chart ---
        fetch('/stats/statuses')
            .then(res => res.json())
            .then(statusData => {
                new Chart(document.getElementById('statusPie'), {
                    type: 'doughnut',
                    data: {
                        labels: Object.keys(statusData),
                        datasets: [{
                            data: Object.values(statusData),
                            backgroundColor: ["#0d6efd", "#ffc107", "#6f42c1"]
                        }]
                    },
                    options: {
                        cutout: '65%',
                        plugins: {
                            legend: { position: 'right' },
                            tooltip: {
                                callbacks: {
                                    label: function (context) {
                                        const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                        const count = context.parsed;
                                        const percent = ((count / total) * 100).toFixed(1);
                                        return `${context.label}: ${count} (${percent}%)`;
                                    }
                                }
                            }
                        }
                    }
                });
            });

        // --- Top Authors Bar Chart ---
        fetch('/stats/authors')
            .then(res => res.json())
            .then(authorData => {
                new Chart(document.getElementById('authorBar'), {
                    type: 'bar',
                    data: {
                        labels: Object.keys(authorData),
                        datasets: [{
                            label: "Books Read",
                            data: Object.values(authorData),
                            backgroundColor: "#0d6efd"
                        }]
                    },
                    options: {
                        indexAxis: 'y',
                        scales: {
                            x: { beginAtZero: true }
                        }
                    }
                });
            });
    });
</script>
{% endblock %}