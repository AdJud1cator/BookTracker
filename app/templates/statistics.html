{% extends "base_member.html" %}

{% block title %}Statistics - BookTracker{% endblock %}


<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>


{% block content %}
<div class="stats-container px-4">
    <div class="chart-card">
        <div class="chart-title">Books by Genre (Top 10)</div>
        <canvas id="genrePie"></canvas>
    </div>
    <div class="chart-card">
        <div class="chart-title">Books Read Over Time</div>
        <div class="mb-3">
            <select id="timeRange" class="form-select" style="max-width:200px;">
                <option value="weeks">By Week</option>
                <option value="months" selected>By Month</option>
                <option value="years">By Year</option>
                <option value="all">All Time</option>
            </select>
        </div>
        <canvas id="booksOverTime"></canvas>
    </div>
    <div class="chart-card">
        <div class="chart-title">Book Status Distribution</div>
        <canvas id="statusPie"></canvas>
    </div>
    <div class="chart-card">
        <div class="chart-title">Top Authors</div>
        <canvas id="authorBar"></canvas>
    </div>
    <div class="chart-card">
        <div class="chart-title">Average Book Length by Genre</div>
        <canvas id="avgPagesBar"></canvas>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // --- Genre Pie Chart ---
    fetch('/stats/genres')
      .then(res => res.json())
      .then(genreData => {
        const genreLabels = Object.keys(genreData);
        const genreCounts = Object.values(genreData);
        new Chart(document.getElementById('genrePie'), {
            type: 'pie',
            data: {
                labels: genreLabels,
                datasets: [{
                    data: genreCounts,
                    backgroundColor: [
                        "#0d6efd", "#6610f2", "#6f42c1", "#d63384", "#fd7e14", "#ffc107", "#198754", "#20c997", "#0dcaf0", "#adb5bd", "#6c757d"
                    ]
                }]
            },
            options: {
                plugins: {
                    legend: { position: 'right' },
                    tooltip: { callbacks: {
                        label: function(context) {
                            const total = context.dataset.data.reduce((a,b)=>a+b,0);
                            const count = context.parsed;
                            const percent = ((count/total)*100).toFixed(1);
                            return `${context.label}: ${count} (${percent}%)`;
                        }
                    }}
                }
            }
        });
      });

    // --- Books Over Time Chart ---
    let booksOverTimeChart;
    function renderBooksOverTime(range) {
        fetch(`/stats/books_over_time?range=${range}`)
          .then(res => res.json())
          .then(booksOverTimeData => {
            const ctx = document.getElementById('booksOverTime');
            if (booksOverTimeChart) booksOverTimeChart.destroy();
            booksOverTimeChart = new Chart(ctx, {
                type: range === 'years' || range === 'all' ? 'bar' : 'line',
                data: {
                    labels: booksOverTimeData.labels,
                    datasets: [{
                        label: "Books Completed",
                        data: booksOverTimeData.data,
                        backgroundColor: "#0d6efd",
                        borderColor: "#0d6efd",
                        tension: 0.25,
                        fill: true
                    }]
                },
                options: {
                    scales: {
                        y: { beginAtZero: true, ticks: { stepSize: 1 } }
                    }
                }
            });
          });
    }
    renderBooksOverTime('months');
    document.getElementById('timeRange').addEventListener('change', function() {
        renderBooksOverTime(this.value);
    });

    // --- Status Pie Chart ---
    fetch('/stats/statuses')
      .then(res => res.json())
      .then(statusData => {
        new Chart(document.getElementById('statusPie'), {
            type: 'pie',
            data: {
                labels: Object.keys(statusData),
                datasets: [{
                    data: Object.values(statusData),
                    backgroundColor: ["#0d6efd", "#ffc107", "#6f42c1"]
                }]
            },
            options: {
                plugins: {
                    legend: { position: 'right' },
                    tooltip: { callbacks: {
                        label: function(context) {
                            const total = context.dataset.data.reduce((a,b)=>a+b,0);
                            const count = context.parsed;
                            const percent = ((count/total)*100).toFixed(1);
                            return `${context.label}: ${count} (${percent}%)`;
                        }
                    }}
                }
            }
        });
      });

    // --- Top Authors Bar Chart ---
    fetch('/stats/authors')
      .then(res => res.json())
      .then(authorData => {
        new Chart(document.getElementById('authorBar'), {
            type: 'bar',
            data: {
                labels: Object.keys(authorData),
                datasets: [{
                    label: "Books Read",
                    data: Object.values(authorData),
                    backgroundColor: "#0d6efd"
                }]
            },
            options: {
                indexAxis: 'y',
                scales: {
                    x: { beginAtZero: true }
                }
            }
        });
      });

    // --- Average Book Length by Genre ---
    fetch('/stats/avg_pages_by_genre')
      .then(res => res.json())
      .then(avgPagesData => {
        new Chart(document.getElementById('avgPagesBar'), {
            type: 'bar',
            data: {
                labels: Object.keys(avgPagesData),
                datasets: [{
                    label: "Average Pages",
                    data: Object.values(avgPagesData),
                    backgroundColor: "#20c997"
                }]
            },
            options: {
                scales: {
                    y: { beginAtZero: true }
                }
            }
        });
      });
});
</script>
{% endblock %}
