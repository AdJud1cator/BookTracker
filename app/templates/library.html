{% extends 'base_member.html' %}

{% block title %}Library - BookTracker{% endblock %}

{% block content %}
<div class="library-section py-4 px-3 min-vh-100">
  <h3 class="fw-semibold mb-3">Last Read / Currently Reading</h3>
  <div id="lastReadSection" class="mb-4"></div>
  <div class="dropdown-section accordion" id="libraryAccordion">
    <div class="accordion-item">
      <h2 class="accordion-header" id="headingCurrent">
        <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapseCurrent"
          aria-expanded="true" aria-controls="collapseCurrent">
          Currently Reading
        </button>
      </h2>
      <div id="collapseCurrent" class="accordion-collapse collapse show" aria-labelledby="headingCurrent"
        data-bs-parent="#libraryAccordion">
        <div class="accordion-body" id="currentlyReadingList"></div>
      </div>
    </div>
    <div class="accordion-item">
      <h2 class="accordion-header" id="headingCompleted">
        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
          data-bs-target="#collapseCompleted" aria-expanded="false" aria-controls="collapseCompleted">
          Completed
        </button>
      </h2>
      <div id="collapseCompleted" class="accordion-collapse collapse" aria-labelledby="headingCompleted"
        data-bs-parent="#libraryAccordion">
        <div class="accordion-body" id="completedList"></div>
      </div>
    </div>
    <div class="accordion-item">
      <h2 class="accordion-header" id="headingWishlist">
        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
          data-bs-target="#collapseWishlist" aria-expanded="false" aria-controls="collapseWishlist">
          Wishlist
        </button>
      </h2>
      <div id="collapseWishlist" class="accordion-collapse collapse" aria-labelledby="headingWishlist"
        data-bs-parent="#libraryAccordion">
        <div class="accordion-body" id="wishlistList"></div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
  function renderLastRead(books) {
    const section = document.getElementById('lastReadSection');
    let book = books.find(b => b.status === 'currently_reading') || books[0];
    if (!book) {
      section.innerHTML = '<div class="text-muted">No books in your library yet.</div>';
      return;
    }
    section.innerHTML = `
        <div class="book-mini">
            <img src="${book.cover_url}" alt="Book cover">
            <div>
                <div class="book-title" title="${book.title}">${book.title}</div>
                <div class="book-author">${book.author}</div>
                <a href="/details?googleid=${book.google_id}" class="btn btn-outline-primary btn-sm mt-2">Details</a>
            </div>
        </div>
    `;
  }

  function renderBookList(books, status, containerId) {
    const list = books.filter(b => b.status === status);
    const container = document.getElementById(containerId);
    if (list.length === 0) {
      container.innerHTML = '<div class="text-muted">No books in this section.</div>';
      return;
    }
    container.innerHTML = list.map(book => `
        <div class="book-list-item">
            <img src="${book.cover_url}" alt="Book cover">
            <div>
                <div class="book-title" title="${book.title}">${book.title}</div>
                <div class="book-author">${book.author}</div>
                <a href="/details?googleid=${book.google_id}" class="btn btn-outline-primary btn-sm mt-1">Details</a>
            </div>
        </div>
    `).join('');
  }

  function loadLibrary() {
    fetch('/my_books')
      .then(response => response.json())
      .then(books => {
        renderLastRead(books);
        renderBookList(books, 'currently_reading', 'currentlyReadingList');
        renderBookList(books, 'completed', 'completedList');
        renderBookList(books, 'wishlist', 'wishlistList');
      });
  }

  loadLibrary();
</script>
{% endblock %}
