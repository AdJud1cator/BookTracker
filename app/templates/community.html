{% extends 'base_member.html' %}

{% block title %}Community - BookTracker{% endblock %}

{% block head %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
<style>
    .section-title {
        font-size: 1.15rem;
        font-weight: 600;
        color: var(--bs-primary, #0d6efd);
        margin-bottom: 0.75rem;
        margin-top: 2.25rem;
    }

    .community-card {
        background: var(--bs-body-bg, #fff);
        border-radius: 0.5rem;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.07);
        padding: 2rem;
        margin-bottom: 2.5rem;
    }

    .autocomplete-list {
        position: absolute;
        left: 0;
        right: 0;
        top: 100%;
        z-index: 20;
        background: var(--bs-body-bg, #fff);
        border: 1px solid #e0e0e0;
        border-radius: 0.5rem;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.07);
        max-height: 220px;
        overflow-y: auto;
        margin-top: 2px;
    }

    .autocomplete-item {
        padding: 0.6rem 1rem;
        cursor: pointer;
        font-size: 1.01rem;
        transition: background 0.13s, color 0.13s;
        border-bottom: 1px solid #f1f1f1;
        color: var(--bs-body-color, #222);
        background: transparent;
        display: flex;
        align-items: center;
        gap: 0.8rem;
    }

    .autocomplete-item:last-child {
        border-bottom: none;
    }

    .autocomplete-item:hover,
    .autocomplete-item.active {
        background: var(--bs-primary-bg-subtle, #e7f1ff);
        color: var(--bs-primary, #0d6efd);
    }

    .autocomplete-item img {
        width: 38px;
        height: 54px;
        object-fit: cover;
        border-radius: 0.2rem;
        background: #ececec;
    }

    .feed-list {
        display: flex;
        flex-direction: column;
        gap: 1.5rem;
    }

    .feed-item {
        display: flex;
        align-items: flex-start;
        gap: 1.5rem;
        background: var(--bs-body-bg, #fff);
        border-radius: 0.5rem;
        box-shadow: 0 1px 4px rgba(0, 0, 0, 0.04);
        padding: 1.2rem;
    }

    .feed-book-cover {
        width: 70px;
        height: 100px;
        object-fit: cover;
        border-radius: 0.3rem;
        background: #eaeaea;
    }

    .feed-book-info {
        flex: 1;
    }

    .feed-book-title {
        font-weight: 600;
        font-size: 1.09rem;
        margin-bottom: 0.18rem;
        color: var(--bs-primary, #0d6efd);
    }

    .feed-book-status {
        font-size: 0.97rem;
        margin-bottom: 0.2rem;
    }

    .feed-meta {
        color: #888;
        font-size: 0.93rem;
    }

    .feed-pagination {
        display: flex;
        justify-content: center;
        gap: 0.5rem;
        margin-top: 1.5rem;
    }

    .feed-pagination button {
        border: none;
        background: var(--bs-primary-bg-subtle, #e7f1ff);
        color: var(--bs-primary, #0d6efd);
        border-radius: 0.3rem;
        padding: 0.4rem 1.1rem;
        font-weight: 500;
        font-size: 1.05rem;
        transition: background 0.13s, color 0.13s;
        cursor: pointer;
    }

    .feed-pagination button.active,
    .feed-pagination button:hover {
        background: var(--bs-primary, #0d6efd);
        color: #fff;
    }

    @media (max-width: 900px) {
        .feed-item {
            flex-direction: column;
            align-items: center;
            text-align: center;
            gap: 0.7rem;
            padding: 1rem 0.5rem;
        }

        .feed-book-info {
            width: 100%;
        }

        .community-card {
            padding: 1.1rem 0.5rem 1.1rem 0.5rem;
        }
    }

    /* Dark mode */
    [data-bs-theme="dark"] .community-card,
    [data-bs-theme="dark"] .feed-item {
        background: #232137;
        color: #f8f9fa;
    }

    [data-bs-theme="dark"] .autocomplete-list {
        background: #232137;
        color: #f8f9fa;
        border-color: #333;
    }

    [data-bs-theme="dark"] .autocomplete-item {
        color: #f8f9fa;
        border-bottom: 1px solid #333;
        background: transparent;
    }

    [data-bs-theme="dark"] .autocomplete-item:hover,
    [data-bs-theme="dark"] .autocomplete-item.active {
        background: #3a8bfd;
        color: #fff !important;
    }

    [data-bs-theme="dark"] .feed-pagination button {
        background: #232137;
        color: #7cb3fa;
        border: 1px solid #3a8bfd;
    }

    [data-bs-theme="dark"] .feed-pagination button.active,
    [data-bs-theme="dark"] .feed-pagination button:hover {
        background: #3a8bfd;
        color: #fff;
    }
</style>
{% endblock %}

{% block content %}
<div class="container my-5 p-4 rounded shadow-sm bg-body" style="max-width:900px;">
    <h2 class="fw-semibold mb-4">Community</h2>

    <!-- Share Card -->
    <div class="community-card position-relative mb-4">
        <div class="section-title" style="margin-top:0;">Share a Book</div>
        <form id="shareForm" autocomplete="off">
            <div class="mb-3 position-relative" style="z-index:12;">
                <label for="bookSearchInput" class="form-label">Book from your library</label>
                <input type="text" id="bookSearchInput" class="form-control" placeholder="Type to search..."
                    autocomplete="off" required>
                <div id="bookSuggestions" class="autocomplete-list" style="display:none;"></div>
            </div>
            <div class="mb-3">
                <label>Status</label>
                <div id="statusDisplay" class="fw-semibold text-primary"></div>
            </div>
            <div class="mb-3 position-relative" style="z-index:11;">
                <label for="userSearchInput" class="form-label">Share with (username)</label>
                <input type="text" id="userSearchInput" class="form-control" placeholder="e.g. alice" required>
                <div id="userSuggestions" class="autocomplete-list" style="display:none;"></div>
            </div>
            <button type="submit" class="btn btn-primary">Share</button>
            <div id="shareMsg" class="mt-2"></div>
        </form>
    </div>

    <!-- Feed Card -->
    <div class="community-card">
        <div class="section-title" style="margin-top:0;">Your News Feed</div>
        <div id="feedList" class="feed-list"></div>
        <div id="feedPagination" class="feed-pagination"></div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    let myLibrary = [];
    let selectedBook = null;
    let userList = [];
    let selectedUser = null;
    let currentUsername = null;
    let feedPage = 1;
    let feedPages = 1;

    // Fuzzy match helper
    function fuzzyMatch(str, query) {
        str = str.toLowerCase();
        query = query.toLowerCase();
        if (str.includes(query)) return true;
        let i = 0;
        for (let c of str) {
            if (c === query[i]) i++;
            if (i === query.length) return true;
        }
        return false;
    }

    // Book autocomplete rendering
    function renderBookSuggestions(matches) {
        const suggestions = document.getElementById('bookSuggestions');
        suggestions.innerHTML = '';
        if (!matches.length) {
            suggestions.style.display = 'none';
            return;
        }
        matches.forEach((book, idx) => {
            const item = document.createElement('div');
            item.className = 'autocomplete-item' + (idx === 0 ? ' active' : '');
            item.innerHTML = `
            <img src="${book.cover_url || 'https://via.placeholder.com/40x60?text=No+Cover'}" alt="">
            <div>
                <div style="font-weight:600;">${book.title}</div>
                <div style="font-size:0.97em;color:var(--bs-primary,#0d6efd);">${book.author}</div>
            </div>
        `;
            item.onmousedown = e => e.preventDefault();
            item.onclick = () => {
                document.getElementById('bookSearchInput').value = book.title;
                suggestions.style.display = 'none';
                selectedBook = book;
                document.getElementById('statusDisplay').textContent = book.status.replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase());
                document.getElementById('statusDisplay').className = "fw-semibold text-primary";
            };
            suggestions.appendChild(item);
        });
        suggestions.style.display = 'block';
    }

    // User autocomplete rendering
    function renderUserSuggestions(matches) {
        const suggestions = document.getElementById('userSuggestions');
        suggestions.innerHTML = '';
        if (!matches.length) {
            suggestions.style.display = 'none';
            return;
        }
        matches.forEach((username, idx) => {
            const item = document.createElement('div');
            item.className = 'autocomplete-item' + (idx === 0 ? ' active' : '');
            item.innerHTML = `<span style="font-weight:600;">${username}</span>`;
            item.onmousedown = e => e.preventDefault();
            item.onclick = () => {
                document.getElementById('userSearchInput').value = username;
                selectedUser = username;
                suggestions.style.display = 'none';
                suggestions.innerHTML = '';
                document.getElementById('userSearchInput').focus();
            };
            suggestions.appendChild(item);
        });
        suggestions.style.display = 'block';
    }

    function renderFeed(feed, page, pages) {
        const feedList = document.getElementById('feedList');
        const feedPagination = document.getElementById('feedPagination');
        if (!feed.length) {
            feedList.innerHTML = '<div class="text-muted">No shares yet. Start sharing books with friends!</div>';
            feedPagination.innerHTML = '';
            return;
        }
        feedList.innerHTML = '';
        feed.forEach(item => {
            const div = document.createElement('div');
            div.className = 'feed-item';
            // Determine message
            let message = "";
            if (currentUsername && item.from_username === currentUsername) {
                message = `You shared <b>${item.title}</b> with <b>${item.to_username}</b> on <span>${item.timestamp}</span>`;
            } else if (currentUsername && item.to_username === currentUsername) {
                message = `<b>${item.from_username}</b> shared <b>${item.title}</b> with you on <span>${item.timestamp}</span>`;
            } else {
                message = `<b>${item.from_username}</b> shared <b>${item.title}</b> with <b>${item.to_username}</b> on <span>${item.timestamp}</span>`;
            }
            div.innerHTML = `
            <img class="feed-book-cover" src="${item.cover_url || 'https://via.placeholder.com/70x100?text=No+Cover'}" alt="Book cover">
            <div class="feed-book-info">
                <div class="feed-book-title">${item.title}</div>
                <div class="feed-book-status">Status: <span class="badge bg-secondary">${item.status.replace('_', ' ')}</span></div>
                <div class="feed-meta">${message}</div>
            </div>
        `;
            feedList.appendChild(div);
        });

        // Pagination UI
        feedPagination.innerHTML = '';
        if (pages > 1) {
            for (let i = 1; i <= pages; i++) {
                const btn = document.createElement('button');
                btn.textContent = i;
                btn.className = (i === page) ? 'active' : '';
                btn.onclick = () => {
                    loadFeed(i);
                    feedPage = i;
                };
                feedPagination.appendChild(btn);
            }
        }
    }

    function loadFeed(page = 1) {
        const feedList = document.getElementById('feedList');
        const feedPagination = document.getElementById('feedPagination');
        feedList.innerHTML = '<div class="text-muted">Loading...</div>';
        feedPagination.innerHTML = '';
        fetch(`/community_feed?page=${page}`)
            .then(res => res.json())
            .then(data => {
                renderFeed(data.feed, data.page, data.pages);
            });
    }

    document.addEventListener('DOMContentLoaded', function () {
        // Get current username for personalized feed
        fetch('/current_username')
            .then(res => res.json())
            .then(data => { currentUsername = data.username; });

        // Fetch user's library for autocomplete
        fetch('/my_library_books')
            .then(res => res.json())
            .then(books => { myLibrary = books; });

        // Fetch all usernames for autocomplete
        fetch('/all_usernames')
            .then(res => res.json())
            .then(users => { userList = users; });

        // Book autocomplete
        const bookInput = document.getElementById('bookSearchInput');
        const bookSuggestions = document.getElementById('bookSuggestions');
        const statusDisplay = document.getElementById('statusDisplay');
        bookInput.addEventListener('input', function (e) {
            const value = bookInput.value.trim().toLowerCase();
            selectedBook = null;
            statusDisplay.textContent = '';
            if (!value) {
                bookSuggestions.style.display = 'none';
                return;
            }
            const matches = myLibrary.filter(book =>
                fuzzyMatch(book.title, value) || fuzzyMatch(book.author, value)
            );
            renderBookSuggestions(matches.slice(0, 8));
        });
        bookInput.addEventListener('focus', function () {
            bookInput.dispatchEvent(new Event('input'));
        });
        document.addEventListener('click', function (e) {
            if (!bookInput.contains(e.target) && !bookSuggestions.contains(e.target)) {
                bookSuggestions.style.display = 'none';
            }
        });

        // User autocomplete (single user)
        const userInput = document.getElementById('userSearchInput');
        const userSuggestions = document.getElementById('userSuggestions');
        userInput.addEventListener('input', function () {
            const value = userInput.value.trim();
            selectedUser = null;
            if (!value) {
                userSuggestions.style.display = 'none';
                return;
            }
            const matches = userList.filter(username => fuzzyMatch(username, value));
            renderUserSuggestions(matches.slice(0, 8));
        });
        userInput.addEventListener('focus', function () {
            userInput.dispatchEvent(new Event('input'));
        });
        document.addEventListener('click', function (e) {
            if (!userInput.contains(e.target) && !userSuggestions.contains(e.target)) {
                userSuggestions.style.display = 'none';
            }
        });

        // Share form submission
        document.getElementById('shareForm').addEventListener('submit', function (e) {
            e.preventDefault();
            const username = userInput.value.trim();
            if (!selectedBook || !username) {
                document.getElementById('shareMsg').textContent = "Please select a book and enter a username.";
                return;
            }
            document.getElementById('shareMsg').textContent = "Sharing...";
            fetch('/share_book', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    book_id: selectedBook.id,
                    username: username,
                    status: selectedBook.status
                })
            })
                .then(res => res.json())
                .then(data => {
                    document.getElementById('shareMsg').textContent = data.message;
                    loadFeed(feedPage); // reload current feed page after sharing
                    // Reset form
                    userInput.value = "";
                    bookInput.value = "";
                    statusDisplay.textContent = "";
                    selectedBook = null;
                    selectedUser = null;
                });
        });

        // Initial feed load
        loadFeed();
    });
</script>
{% endblock %}