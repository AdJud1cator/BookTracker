{% extends 'base_member.html' %}

{% block title %}Explore Books - BookTracker{% endblock %}

{% block head %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
<style>
    .search-bar {
        display: flex;
        gap: 0.5rem;
        max-width: 600px;
        margin: 0 auto 2rem auto;
        flex-wrap: wrap;
        justify-content: center;
    }
    .search-bar input[type="text"] {
        flex: 1;
        min-width: 180px;
        padding: 0.75rem;
        font-size: 1.1rem;
        border: 1px solid var(--bs-border-color);
        border-radius: 0.5rem;
        background-color: var(--bs-body-bg);
        color: var(--bs-body-color);
    }
    .search-bar button {
        padding: 0.75rem 1.5rem;
        font-size: 1.1rem;
        border-radius: 0.5rem;
        border: none;
        background: var(--bs-primary);
        color: #fff;
        font-weight: 500;
    }
    .books-grid {
        display: flex;
        flex-wrap: wrap;
        gap: 1.5rem;
        justify-content: center;
        margin-top: 2rem;
    }
    .book-card {
        background: var(--bs-body-bg);
        border-radius: 0.5rem;
        box-shadow: 0 2px 8px rgba(0,0,0,0.07);
        padding: 1rem;
        display: flex;
        flex-direction: column;
        align-items: center;
        min-width: 170px;
        max-width: 200px;
        min-height: 320px;
        transition: transform 0.15s;
        color: var(--bs-body-color);
    }
    .book-card:hover {
        transform: translateY(-4px) scale(1.03);
        box-shadow: 0 4px 16px rgba(0,0,0,0.13);
    }
    .book-card img {
        width: 110px;
        height: 160px;
        object-fit: cover;
        border-radius: 0.25rem;
        margin-bottom: 0.75rem;
    }
    .book-title {
        font-weight: 600;
        font-size: 1.05rem;
        margin-bottom: 0.25rem;
        text-align: center;
        max-width: 180px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    .book-author {
        font-size: 0.96rem;
        color: var(--bs-primary);
        margin-bottom: 0.5rem;
        text-align: center;
    }
    .book-desc {
        font-size: 0.92rem;
        color: var(--bs-secondary-color);
        text-align: center;
    }
</style>
{% endblock %}

{% block content %}
<div class="container my-5 p-4 rounded shadow-sm bg-body">
    <h2 class="fw-semibold mb-4">Explore Books</h2>
    <form class="search-bar" id="searchForm" autocomplete="off">
        <input type="text" id="searchInput" placeholder="Search for books by title, author, or keyword..." autocomplete="off">
        <button type="submit">Search</button>
    </form>
    <h4 id="resultsTitle" class="mb-4">Trending Books</h4>
    <div class="books-grid" id="booksGrid"></div>
</div>
{% endblock %}

{% block scripts %}
<script>
    async function fetchBooks(query, maxResults = 20, orderBy = 'relevance') {
        const url = `https://www.googleapis.com/books/v1/volumes?q=${encodeURIComponent(query)}&maxResults=${maxResults}&orderBy=${orderBy}`;
        const resp = await fetch(url);
        const data = await resp.json();
        return (data.items || []);
    }

    function truncateTitle(title, maxLength = 50) {
        return title.length > maxLength ? title.substring(0, maxLength - 1) + '…' : title;
    }

    function renderBooks(books) {
        const grid = document.getElementById('booksGrid');
        grid.innerHTML = '';
        if (books.length === 0) {
            grid.innerHTML = '<p style="text-align:center; color:var(--bs-secondary-color); width:100%;">No books found.</p>';
            return;
        }
        books.forEach(book => {
            const info = book.volumeInfo || {};
            const img = (info.imageLinks && info.imageLinks.thumbnail) || 'https://via.placeholder.com/110x160?text=No+Cover';
            const title = info.title ? truncateTitle(info.title) : 'No Title';
            const authors = (info.authors && info.authors.join(', ')) || 'Unknown Author';
            const desc = info.description ? info.description.substring(0, 80) + (info.description.length > 80 ? '…' : '') : '';
            const detailsUrl = `/details?googleid=${book.id}`;
            const card = document.createElement('a');
            card.className = 'book-card';
            card.href = detailsUrl;
            card.style.textDecoration = 'none'; // Optional: removes underline from link
            card.innerHTML = `
                <img src="${img}" alt="Book cover">
                <div class="book-title" title="${info.title || ''}">${title}</div>
                <div class="book-author">${authors}</div>
                <div class="book-desc">${desc}</div>
            `;
            grid.appendChild(card);
        });
    }

    async function loadTrendingBooks() {
        document.getElementById('resultsTitle').textContent = 'Trending Books';
        const trendingBooks = await fetchBooks('bestsellers', 20, 'relevance');
        renderBooks(trendingBooks);
    }

    document.getElementById('searchForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        const query = document.getElementById('searchInput').value.trim();
        if (!query) {
            loadTrendingBooks();
            return;
        }
        document.getElementById('resultsTitle').textContent = `Search Results for "${query}"`;
        const books = await fetchBooks(query, 20, 'relevance');
        renderBooks(books);
    });

    loadTrendingBooks();
</script>
{% endblock %}
